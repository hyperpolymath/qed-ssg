# SPDX-License-Identifier: AGPL-3.0-or-later
# RSR-compliant CI workflow with SHA-pinned actions

name: CI

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main"]

permissions: read-all

env:
  DENO_VERSION: "1.40.0"

jobs:
  # ============================================================================
  # LINT JOB
  # ============================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Deno
        uses: denoland/setup-deno@5fae568d37c3b73449009674875529a984555dd1 # v2.0.2
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: Check formatting
        run: deno fmt --check adapters/

      - name: Lint JavaScript
        run: deno lint adapters/

      - name: Check SPDX headers
        run: |
          for f in adapters/*.js; do
            if ! head -1 "$f" | grep -q 'SPDX-License-Identifier'; then
              echo "Missing SPDX header: $f"
              exit 1
            fi
          done
          echo "All SPDX headers present"

  # ============================================================================
  # TEST JOB
  # ============================================================================
  test:
    name: Test
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Deno
        uses: denoland/setup-deno@5fae568d37c3b73449009674875529a984555dd1 # v2.0.2
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: Run unit tests
        run: deno test --allow-read --allow-run adapters/

      - name: Run tests with coverage
        run: |
          deno test --coverage=coverage/ --allow-read --allow-run adapters/
          deno coverage coverage/ --lcov > coverage.lcov

      - name: Upload coverage
        uses: codecov/codecov-action@13ce3aa6a8f2324fef00519cbe4deef7cc2e0e61 # v5.3.1
        with:
          files: coverage.lcov
          fail_ci_if_error: false

  # ============================================================================
  # SECURITY AUDIT JOB
  # ============================================================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Check for eval() usage
        run: |
          if grep -rn 'eval(' adapters/; then
            echo "ERROR: eval() usage detected!"
            exit 1
          fi
          echo "No eval() usage found"

      - name: Check for unsafe exec
        run: |
          if grep -rn 'exec(' adapters/ | grep -v 'Deno.Command'; then
            echo "ERROR: Unsafe exec() usage detected!"
            exit 1
          fi
          echo "No unsafe exec() usage found"

      - name: Check for hardcoded secrets
        run: |
          if grep -rn 'password\s*=\s*["\x27]' adapters/ --include="*.js"; then
            echo "WARNING: Possible hardcoded secrets!"
            exit 1
          fi
          if grep -rn 'api.key\s*=\s*["\x27]' adapters/ --include="*.js"; then
            echo "WARNING: Possible hardcoded API keys!"
            exit 1
          fi
          echo "No hardcoded secrets found"

      - name: Verify parameterized commands
        run: |
          # All adapters should use Deno.Command with args array
          for f in adapters/*.js; do
            if ! grep -q 'new Deno.Command' "$f"; then
              echo "WARNING: $f may not use Deno.Command"
            fi
            if ! grep -q 'args,' "$f" && ! grep -q 'args:' "$f"; then
              echo "WARNING: $f may not use parameterized args"
            fi
          done
          echo "Command execution patterns verified"

  # ============================================================================
  # BUILD JOB
  # ============================================================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, test, security]
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Deno
        uses: denoland/setup-deno@5fae568d37c3b73449009674875529a984555dd1 # v2.0.2
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: Type check adapters
        run: deno check adapters/*.js

      - name: Verify adapter exports
        run: |
          for f in adapters/*.js; do
            echo "Checking $f..."
            deno eval "
              import * as a from './$f';
              if (!a.name) throw new Error('Missing name export');
              if (!a.language) throw new Error('Missing language export');
              if (!a.tools) throw new Error('Missing tools export');
              console.log('  âœ“', a.name, '-', a.language);
            " || exit 1
          done
          echo "All adapters validated!"

  # ============================================================================
  # E2E TEST JOB (optional, runs on main only)
  # ============================================================================
  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Deno
        uses: denoland/setup-deno@5fae568d37c3b73449009674875529a984555dd1 # v2.0.2
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: Run E2E tests
        run: |
          mkdir -p tests/e2e
          # E2E tests will be added here
          echo "E2E test placeholder - add tests/e2e/*.ts files"
